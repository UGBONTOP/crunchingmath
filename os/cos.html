<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="os-title">Crunch' OS</title>
    <link id="favicon" rel="icon" type="image/x-icon" href="https://lucide.dev/favicon.ico">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=Fira+Code:wght@400;500&display=swap');

        :root {
            --accent: #00f2ff;
            --bg-dark: #0a0a0c;
            --glass: rgba(20, 20, 25, 0.6);
            --glass-light: rgba(255, 255, 255, 0.1);
            --desktop-bg: url('https://images.unsplash.com/photo-1451187580459-43490279c0fa?q=80&w=2072&auto=format&fit=crop');
            --spotify-green: #1DB954;
            /* Glossy Shine Effect */
            --gloss: linear-gradient(135deg, rgba(255,255,255,0.3) 0%, rgba(255,255,255,0) 50%, rgba(0,0,0,0.1) 100%);
            --bg-overlay: rgba(0, 0, 0, 0.5);
        }

        /* Themes */
        body.theme-crimson { --accent: #ff4d4d; }
        body.theme-emerald { --accent: #10b981; }
        body.theme-gold { --accent: #f59e0b; }
        body.theme-void { --accent: #ffffff; }

        body, html {
            margin: 0; padding: 0; height: 100%; overflow: hidden;
            font-family: 'Inter', sans-serif; background: #000; color: white;
            user-select: none;
        }

        .desktop {
            background: var(--bg-overlay) var(--desktop-bg);
            background-size: cover; background-position: center; background-blend-mode: multiply;
            height: 100vh; width: 100vw; position: relative; overflow: hidden;
        }

        /* UI REMAKE: Smoother Glass & Gloss */
        .glass {
            background: var(--glass); 
            backdrop-filter: blur(25px) saturate(180%); 
            -webkit-backdrop-filter: blur(25px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.15);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.6);
        }

        .glossy-finish {
            position: relative;
            overflow: hidden;
        }
        .glossy-finish::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: var(--gloss);
            pointer-events: none;
            z-index: 1;
        }

        .window {
            position: absolute; min-width: 320px; min-height: 240px;
            display: flex; flex-direction: column; border-radius: 16px;
            overflow: hidden; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.7);
            transition: width 0.3s cubic-bezier(0.2, 0.8, 0.2, 1), height 0.3s cubic-bezier(0.2, 0.8, 0.2, 1), top 0.3s, left 0.3s, transform 0.2s, opacity 0.2s;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .window.maximized {
            top: 0 !important; left: 0 !important;
            width: 100vw !important; height: calc(100vh - 4.5rem) !important;
            border-radius: 0; border: none;
        }

        /* when fullscreen setting is enabled we will add this */
        .window.fullscreened {
            top: 0 !important; left: 0 !important;
            width: 100vw !important; height: 100vh !important;
            border-radius: 0; border: none;
        }

        .window.minimized {
            opacity: 0; transform: scale(0.7) translateY(400px); pointer-events: none;
        }

        .window-header {
            padding: 0 0 0 15px; display: flex; justify-content: space-between;
            align-items: center; background: rgba(255, 255, 255, 0.07); border-bottom: 1px solid rgba(255,255,255,0.1);
            cursor: default; height: 40px;
        }

        .terminal-font { font-family: 'Fira Code', monospace; }
        .app-icon-shadow { filter: drop-shadow(0 4px 6px rgba(0,0,0,0.5)); }

        /* GLOSSY TASKBAR */
        .taskbar {
            position: fixed; bottom: 1rem; left: 50%; transform: translateX(-50%);
            height: 4rem; glass: blur(30px); border-radius: 24px;
            padding: 0 1rem; display: flex; items-center; gap: 0.5rem;
            z-index: 9000; border: 1px solid rgba(255,255,255,0.2);
            background: rgba(15, 15, 20, 0.4);
            box-shadow: 0 20px 40px rgba(0,0,0,0.4), inset 0 1px 1px rgba(255,255,255,0.3);
            transition: opacity 0.25s ease, transform 0.25s ease;
        }
        .taskbar::after {
            content: ''; position: absolute; top: 0; left: 0; right: 0; height: 50%;
            background: linear-gradient(to bottom, rgba(255,255,255,0.15), transparent);
            border-radius: 24px 24px 0 0; pointer-events: none;
        }

        /* hidden while fullscreen mode is active (user setting) */
        .taskbar.hidden-fullscreen {
            opacity: 0; transform: translateY(18px); pointer-events: none;
        }

        .taskbar-item { transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); position: relative; }
        .taskbar-item:hover { background: rgba(255,255,255,0.15); transform: translateY(-6px) scale(1.1); }
        .taskbar-item.running::after {
            content: ''; position: absolute; bottom: 6px; left: 50%; transform: translateX(-50%);
            width: 5px; height: 5px; background: var(--accent); border-radius: 50%; box-shadow: 0 0 10px var(--accent);
        }

        #start-menu { transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1), opacity 0.3s; }
        #start-menu.hidden-menu { transform: translate(-50%, 40px) scale(0.9); opacity: 0; pointer-events: none; }

        /* Icon Polish */
        .app-icon-container {
            position: relative;
            box-shadow: 0 10px 20px rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.1);
            overflow: hidden;
        }
        .app-icon-container::after {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 50%;
            background: linear-gradient(rgba(255,255,255,0.2), transparent);
            pointer-events: none;
        }

        /* Disclaimer Blur */
        #disclaimer-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.4); 
            backdrop-filter: blur(15px); z-index: 10001;
            display: none; align-items: center; justify-content: center;
        }

        #boot-screen {
            position: fixed; inset: 0; background: #000; z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .boot-ghost {
            font-size: 5rem; color: var(--accent);
            filter: drop-shadow(0 0 20px var(--accent));
            animation: boot-pulse 2.5s ease-in-out infinite;
        }
        @keyframes boot-pulse { 0%, 100% { transform: scale(1); opacity: 0.8; } 50% { transform: scale(1.1); opacity: 1; } }

        #notification-area { position: fixed; top: 20px; right: 20px; z-index: 10000; display: flex; flex-direction: column; gap: 10px; }
        .toast {
            background: var(--glass); border-left: 4px solid var(--accent);
            padding: 12px 20px; border-radius: 8px; width: 300px;
            animation: slideInRight 0.3s ease forwards;
        }
        @keyframes slideInRight { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        .settings-nav-item.active {
            background: rgba(255, 255, 255, 0.1);
            border-left: 3px solid var(--accent);
        }

        .win-ctrl {
            width: 45px; height: 40px; display: flex; align-items: center; justify-content: center;
            transition: background 0.2s; color: white;
        }
        .win-ctrl:hover { background: rgba(255, 255, 255, 0.1); }
        .win-ctrl-close:hover { background: #e81123 !important; }

        .accent-color { color: var(--accent); }
        .accent-bg { background: var(--accent); }
        .accent-border { border-color: var(--accent); }

        .calc-btn { background: rgba(255,255,255,0.05); padding: 15px; border-radius: 8px; text-align: center; cursor: pointer; transition: 0.2s; }
        .calc-btn:hover { background: rgba(255,255,255,0.15); }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--accent); }

        /* Windows 10-ish Settings look (added) */
        .settings-shell {
            display: flex; height: 100%;
        }
        .settings-left {
            width: 220px; background: rgba(255,255,255,0.03); padding: 18px; border-right: 1px solid rgba(255,255,255,0.03);
            display: flex; flex-direction: column; gap: 8px;
        }
        .settings-left .section {
            font-size: 12px; color: #c7c7c7; margin-bottom: 8px; text-transform: uppercase; letter-spacing: .08em;
        }
        .settings-category {
            padding: 10px 12px; border-radius: 8px; display:flex; gap:10px; align-items:center; cursor:pointer; color:#e6e6e6;
        }
        .settings-category:hover { background: rgba(255,255,255,0.02); }
        .settings-right {
            flex-grow: 1; padding: 26px; overflow:auto;
        }

        /* OS Design appearance tweaks */
        body.os-win10 .taskbar {
            left: 0; transform: none; width: 100%; border-radius: 0; bottom: 0; padding: 0 12px; height: 48px;
            justify-content: flex-start; gap: 8px; align-items: center;
            background: linear-gradient(180deg, rgba(30,30,30,0.95), rgba(10,10,10,0.95));
            box-shadow: 0 -2px 8px rgba(0,0,0,0.5);
        }
        body.os-win10 .taskbar .group { margin-left: 12px; }

        body.os-macos .taskbar {
            left: 50%; transform: translateX(-50%); bottom: 22px; width: auto; padding: 6px 12px; border-radius: 999px;
            background: rgba(255,255,255,0.06); box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        body.os-macos .taskbar .taskbar-item { margin: 0 6px; transform-origin: center bottom; transition: transform 0.12s ease; }
        body.os-macos .taskbar .taskbar-item:hover { transform: translateY(-6px) scale(1.25); }

        /* keep existing look when default */
        body.os-default { /* no overrides */ }

    </style>
</head>
<body class="theme-default">

    <div id="boot-screen">
        <div class="boot-ghost mb-8">
            <i data-lucide="ghost" style="width: 80px; height: 80px;"></i>
        </div>
        <div class="crunch-logo mb-8 font-black text-3xl tracking-tighter" style="color: white">CRUNCH OS</div>
        <div class="relative w-48 h-1 bg-gray-900 rounded-full overflow-hidden">
            <div id="boot-progress" class="absolute top-0 left-0 h-full accent-bg w-0 transition-all duration-100"></div>
        </div>
    </div>

    <div id="disclaimer-overlay">
        <div class="glass p-8 rounded-3xl max-w-md border-white/20 shadow-2xl glossy-finish">
            <h2 class="text-2xl font-black text-red-500 mb-4 flex items-center gap-2">
                <i data-lucide="alert-triangle"></i> ALERT!
            </h2>
            <p class="text-gray-200 text-sm leading-relaxed mb-6">
                Using a proxy can hold you lieable for fuhing around with school property, risk if you want but im not lieable for ur choices.
            </p>
            <button id="accept-disclaimer" class="w-full bg-white text-black py-3 rounded-xl font-bold hover:bg-gray-200 transition-colors">I UNDERSTAND</button>
        </div>
    </div>

    <div id="notification-area"></div>

    <div class="desktop" id="desktop" oncontextmenu="showContextMenu(event)">
        
        <div class="p-6 flex flex-col flex-wrap content-start h-[calc(100vh-4rem)] gap-4" id="desktop-icons"></div>

        <div class="taskbar glass">
            <button onclick="toggleStartMenu()" class="p-2.5 hover:bg-white/10 rounded-xl accent-color transition-colors group relative">
                <i data-lucide="ghost" id="taskbar-ghost" class="w-6 h-6 group-hover:rotate-12 transition-transform"></i>
            </button>
            <div class="h-8 w-[1px] bg-white/10 mx-1 self-center"></div>
            <div id="taskbar-apps" class="flex gap-2 items-center"></div>
            <div class="h-8 w-[1px] bg-white/10 mx-1 self-center"></div>
            <div class="flex items-center gap-4 px-3 text-xs font-medium text-gray-300 cursor-default">
                <div class="text-right leading-tight">
                    <div id="clock-time" class="font-bold text-white">12:00 PM</div>
                    <div id="clock-date" class="text-[10px] text-gray-400">Jan 1, 2026</div>
                </div>
                <div class="flex gap-3 text-gray-400">
                    <i data-lucide="wifi" class="w-4"></i>
                    <i data-lucide="volume-2" class="w-4"></i>
                </div>
            </div>
        </div>

        <div id="start-menu" class="fixed bottom-24 left-1/2 -translate-x-1/2 w-[420px] h-[550px] glass rounded-[32px] z-[9001] hidden-menu p-6 flex flex-col glossy-finish">
            <div class="flex items-center gap-3 mb-6 relative z-10">
                <div class="w-12 h-12 rounded-full bg-gradient-to-tr from-cyan-400 to-blue-600 shadow-lg flex items-center justify-center text-xl font-bold">C</div>
                <div>
                    <div class="font-bold text-lg">Crunch User</div>
                    <div class="text-xs text-gray-400">Administrator</div>
                </div>
            </div>
            <div class="relative mb-6 z-10">
                <i data-lucide="search" class="absolute left-3 top-2.5 w-4 h-4 text-gray-500"></i>
                <input type="text" placeholder="Search apps, files, and settings..." class="w-full bg-white/5 border border-white/10 rounded-xl pl-10 pr-4 py-2 outline-none focus:border-cyan-500/50 transition-colors text-sm">
            </div>
            <div class="text-xs font-bold text-gray-500 mb-3 uppercase tracking-wider relative z-10">Pinned Apps</div>
            <div class="grid grid-cols-4 gap-4 overflow-y-auto flex-grow p-1 relative z-10" id="start-menu-grid"></div>
            <div class="mt-auto pt-4 border-t border-white/10 flex justify-between text-gray-400 relative z-10">
                <button onclick="location.reload()" class="p-2 hover:bg-white/10 rounded-lg flex gap-2 items-center text-xs"><i data-lucide="power" class="w-4"></i> Restart</button>
                <button class="p-2 hover:bg-white/10 rounded-lg flex gap-2 items-center text-xs"><i data-lucide="lock" class="w-4"></i> Lock</button>
            </div>
        </div>
    </div>

    <audio id="sound-boot" src="https://assets.mixkit.co/active_storage/sfx/2561/2561-preview.mp3"></audio>
    <audio id="sound-notify" src="https://assets.mixkit.co/active_storage/sfx/2357/2357-preview.mp3"></audio>

    <script>
        const CLOAK_PRESETS = {
            none: { title: "Crunch' OS On Top", icon: "https://lucide.dev/favicon.ico" },
            drive: { title: "My Drive - Google Drive", icon: "https://ssl.gstatic.com/images/branding/product/1x/drive_2020q4_32dp.png" },
            ixl: { title: "IXL | Personalized Learning", icon: "https://www.ixl.com/favicon.ico" },
            schoology: { title: "Home | Schoology", icon: "https://asset-cdn.schoology.com/sites/all/themes/schoology_theme/favicon.ico" },
            powerschool: { title: "Powerschool - Login", icon: "https://www.powerschool.com/favicon.ico" },
            skyward: { title: "Skyward - Student Access", icon: "https://www.skyward.com/favicon.ico" },
            google: { title: "Google", icon: "https://www.google.com/favicon.ico" }
        };

        const DEFAULT_WALLPAPERS = [
            { name: 'Cosmic Blue', url: 'https://images.unsplash.com/photo-1451187580459-43490279c0fa', type: 'static' },
            { name: 'Neon Peak', url: 'https://images.unsplash.com/photo-1614850523296-d8c1af93d400', type: 'static' },
            { name: 'Dark Abstract', url: 'https://images.unsplash.com/photo-1550684848-fac1c5b4e853', type: 'static' },
            { name: 'Cyber City', url: 'https://images.unsplash.com/photo-1534796636912-3b95b3ab5986', type: 'static' },
            { name: 'Retro Sunset', url: 'https://images.unsplash.com/photo-1614359833859-45733592c6a5', type: 'static' },
            { name: 'Oceanic Deep', url: 'https://images.unsplash.com/photo-1557683316-973673baf926', type: 'static' },
            { name: 'Forest Mist', url: 'https://images.unsplash.com/photo-1441974231531-c6227db76b6e', type: 'static' },
            { name: 'Crimson Void', url: 'https://images.unsplash.com/photo-1579546929518-9e396f3cc809', type: 'static' },
            { name: 'Mountain Night', url: 'https://images.unsplash.com/photo-1464822759023-fed622ff2c3b', type: 'static' },
            { name: 'Glassy Gradient', url: 'https://images.unsplash.com/photo-1550684376-efcbd6e3f031', type: 'static' },
            { name: 'Matrix Rain', url: 'https://media.giphy.com/media/v1.Y2lkPTc5MGI3NjExOHpwaG5xbmR5M3B3eHN5eXhyeXhyeXhyeXhyeXhyeXhyeCZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/3o7TKMG7X5L6E0B19e/giphy.gif', type: 'gif' },
            { name: 'Pixel Wave', url: 'https://media.giphy.com/media/v1.Y2lkPTc5MGI3NjExcm5mN3V5YXZxbmR5M3B3eHN5eXhyeXhyeXhyeXhyeXhyeXhyeCZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/LMc7vGSWn5Y8F70585/giphy.gif', type: 'gif' },
            { name: 'Retrowave', url: 'https://media.giphy.com/media/v1.Y2lkPTc5MGI3NjExbm5mN3V5YXZxbmR5M3B3eHN5eXhyeXhyeXhyeXhyeXhyeXhyeCZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/3o7TKMG7X5L6E0B19e/giphy.gif', type: 'gif' },
            { name: 'Vaporwave Sun', url: 'https://media.giphy.com/media/v1.Y2lkPTc5MGI3NjExbm5mN3V5YXZxbmR5M3B3eHN5eXhyeXhyeXhyeXhyeXhyeXhyeCZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/26BRv0ThflsHCqDrG/giphy.gif', type: 'gif' },
            { name: 'Cyberpunk Rain', url: 'https://media.giphy.com/media/v1.Y2lkPTc5MGI3NjExbm5mN3V5YXZxbmR5M3B3eHN5eXhyeXhyeXhyeXhyeXhyeXhyeCZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/fTzXYEcl949s4/giphy.gif', type: 'gif' },
            { name: 'Lofi Coffee', url: 'https://media.giphy.com/media/v1.Y2lkPTc5MGI3NjExbm5mN3V5YXZxbmR5M3B3eHN5eXhyeXhyeXhyeXhyeXhyeXhyeCZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/v2xCH2DU9sPg6LRp4B/giphy.gif', type: 'gif' },
            { name: 'Space Journey', url: 'https://media.giphy.com/media/v1.Y2lkPTc5MGI3NjExbm5mN3V5YXZxbmR5M3B3eHN5eXhyeXhyeXhyeXhyeXhyeXhyeCZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/3o7TKVUn7iM8FMEU24/giphy.gif', type: 'gif' },
            { name: 'Digital Rain', url: 'https://media.giphy.com/media/v1.Y2lkPTc5MGI3NjExbm5mN3V5YXZxbmR5M3B3eHN5eXhyeXhyeXhyeXhyeXhyeXhyeCZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/fTzXYEcl949s4/giphy.gif', type: 'gif' },
            { name: 'Synthwave Glider', url: 'https://media.giphy.com/media/v1.Y2lkPTc5MGI3NjExbm5mN3V5YXZxbmR5M3B3eHN5eXhyeXhyeXhyeXhyeXhyeXhyeCZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/v2xCH2DU9sPg6LRp4B/giphy.gif', type: 'gif' },
            { name: 'Glitch Tech', url: 'https://media.giphy.com/media/v1.Y2lkPTc5MGI3NjExbm5mN3V5YXZxbmR5M3B3eHN5eXhyeXhyeXhyeXhyeXhyeXhyeCZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/26BRv0ThflsHCqDrG/giphy.gif', type: 'gif' }
        ];

        const DEFAULT_APPS = {
            browser: { name: 'Web Browser', icon: 'globe', color: 'text-blue-400', bg: 'bg-blue-400/20', url: 'https://ixl-alternativelinks.web.app', pinned: true },
            terminal: { name: 'Terminal', icon: 'terminal-square', color: 'text-green-400', bg: 'bg-green-400/20', pinned: true },
            music: { name: 'Spotify Music', icon: 'music', color: 'text-green-500', bg: 'bg-green-500/20', pinned: true },
            gameshub: { name: 'Games Hub', icon: 'gamepad-2', color: 'text-purple-400', bg: 'bg-purple-400/20', url: 'https://crunchingmath.web.app', pinned: true },
            files: { name: 'Files', icon: 'folder-open', color: 'text-yellow-400', bg: 'bg-yellow-400/20', pinned: true },
            notepad: { name: 'Notepad', icon: 'file-text', color: 'text-blue-300', bg: 'bg-blue-300/20', pinned: true },
            calculator: { name: 'Calculator', icon: 'calculator', color: 'text-orange-400', bg: 'bg-orange-400/20', pinned: true },
            wallpapers: { name: 'Wallpapers', icon: 'image', color: 'text-pink-400', bg: 'bg-pink-400/20', pinned: true },
            htmlviewer: { name: 'HTML Viewer', icon: 'code-2', color: 'text-orange-400', bg: 'bg-orange-400/20', pinned: true },
            custominstaller: { name: 'Install Custom', icon: 'plus-square', color: 'text-pink-400', bg: 'bg-pink-400/20', pinned: true },
            settings: { name: 'Settings', icon: 'settings', color: 'text-gray-300', bg: 'bg-gray-300/20', pinned: true },
            snake: { name: 'Snake Game', icon: 's', color: 'text-green-500', bg: 'bg-green-500/10', hidden: true },
            zombie: { name: 'Zombie Defense', icon: 'skull', color: 'text-red-500', bg: 'bg-red-500/10', hidden: true },
            tetris: { name: 'Blocks', icon: 'layout-grid', color: 'text-blue-500', bg: 'bg-blue-500/10', hidden: true },
        };

        let APPS = { ...DEFAULT_APPS };
        let openWindows = [];
        let zIndexCounter = 100;
        let windowCleanupCallbacks = {};
        let systemNotes = localStorage.getItem('crunch_notes') || '';
        let browserLaunchTarget = null;

        window.onload = initSystem;

        function initSystem() {
            loadCustomApps();
            loadSettings();
            lucide.createIcons();
            startClock();
            renderStartMenu();
            renderDesktopIcons();
            simulateBootProcess();

            document.getElementById('accept-disclaimer').onclick = () => {
                document.getElementById('disclaimer-overlay').style.display = 'none';
                if(browserLaunchTarget) {
                    finalizeLaunch(browserLaunchTarget);
                    browserLaunchTarget = null;
                }
            };
        }

        function loadCustomApps() {
            const saved = localStorage.getItem('crunch_custom_apps');
            if(saved) {
                const customApps = JSON.parse(saved);
                APPS = { ...DEFAULT_APPS, ...customApps };
            }
        }

        function loadSettings() {
            const theme = localStorage.getItem('crunch_theme') || 'default';
            const bg = localStorage.getItem('crunch_bg') || 'https://images.unsplash.com/photo-1451187580459-43490279c0fa?q=80&w=2072&auto=format&fit=crop';
            const cloak = localStorage.getItem('crunch_cloak') || 'none';
            const brightness = localStorage.getItem('crunch_brightness') || '0.5';
            const taskbarHide = localStorage.getItem('crunch_taskbar_hide_fullscreen') || 'false';
            const osDesign = localStorage.getItem('crunch_os_design') || 'default';
            
            document.body.className = `theme-${theme}`;
            document.documentElement.style.setProperty('--desktop-bg', `url('${bg}')`);
            document.documentElement.style.setProperty('--bg-overlay', `rgba(0, 0, 0, ${brightness})`);
            applyCloak(cloak);
            applyOSDesign(osDesign);
            updateTaskbarVisibility();
        }

        function simulateBootProcess() {
            const progress = document.getElementById('boot-progress');
            const bootSfx = document.getElementById('sound-boot');
            let width = 0;
            
            const interval = setInterval(() => {
                width += Math.random() * 8;
                if(width > 100) width = 100;
                progress.style.width = width + '%';
                
                if (width >= 100) {
                    clearInterval(interval);
                    bootSfx.play().catch(e => console.log("Audio requires interaction"));
                    setTimeout(() => {
                        document.getElementById('boot-screen').style.opacity = 0;
                        setTimeout(() => {
                             document.getElementById('boot-screen').remove();
                             sendNotification('Crunch OS V3.1', 'System update complete. Welcome back!', 'sparkles');
                        }, 500);
                    }, 800);
                }
            }, 100);
        }

        function launchApp(appKey) {
            if(appKey === 'browser') {
                browserLaunchTarget = appKey;
                document.getElementById('disclaimer-overlay').style.display = 'flex';
                return;
            }
            finalizeLaunch(appKey);
        }

        function finalizeLaunch(appKey) {
            const app = APPS[appKey];
            if(!app) return;

            const id = 'win-' + Date.now();
            zIndexCounter++;
            
            const win = document.createElement('div');
            win.id = id;
            win.className = 'window glass';
            const offset = (openWindows.length % 10) * 20;
            win.style.left = (100 + offset) + 'px';
            win.style.top = (80 + offset) + 'px';
            win.style.zIndex = zIndexCounter;
            
            win.style.width = (appKey === 'browser' || appKey === 'settings' || appKey === 'custominstaller' || appKey === 'music' || appKey === 'files' || appKey === 'gameshub' || appKey === 'wallpapers') ? '900px' : '600px';
            win.style.height = (appKey === 'browser' || appKey === 'settings' || appKey === 'custominstaller' || appKey === 'music' || appKey === 'files' || appKey === 'gameshub' || appKey === 'wallpapers') ? '600px' : '400px';

            if(appKey === 'calculator') { win.style.width = '300px'; win.style.height = '450px'; }

            win.innerHTML = `
                <div class="window-header ondrag-handle glossy-finish" ondblclick="toggleMaximize('${id}')">
                    <div class="flex items-center gap-3 text-sm font-medium text-gray-200 pointer-events-none relative z-10">
                        ${app.isCustom && app.customIcon ? `<img src="${app.customIcon}" class="w-4 h-4 rounded-sm">` : `<i data-lucide="${app.icon}" class="w-4 h-4 ${app.color}"></i>`}
                        ${app.name}
                    </div>
                    <div class="flex relative z-10">
                        <button onclick="minimizeWindow('${id}')" class="win-ctrl"><i data-lucide="minus" class="w-3.5 h-3.5"></i></button>
                        <button onclick="toggleMaximize('${id}')" class="win-ctrl"><i data-lucide="square" class="w-3 h-3" id="max-btn-${id}"></i></button>
                        <button onclick="closeWindow('${id}')" class="win-ctrl win-ctrl-close"><i data-lucide="x" class="w-4 h-4"></i></button>
                    </div>
                </div>
                <div class="flex-grow overflow-hidden relative bg-black/20" id="content-${id}"></div>
            `;

            document.getElementById('desktop').appendChild(win);
            document.getElementById(`content-${id}`).innerHTML = getAppContent(appKey, id);

            openWindows.push({ id, appKey, state: 'normal', savedDims: {} });
            
            setupDraggable(id);
            focusWindow(id);
            updateTaskbar();
            lucide.createIcons();

            if(appKey === 'settings') loadSettingsPage(id, 'appearance');
            if(appKey === 'terminal') initTerminal(id);
            if(appKey === 'music') initMusicApp(id);
            if(appKey === 'snake') initSnakeGame(id);
            if(appKey === 'zombie') initZombieGame(id);
            if(appKey === 'files') initFilesApp(id);
        }

        function focusWindow(id) {
            const win = document.getElementById(id);
            if(!win) return;
            zIndexCounter++;
            win.style.zIndex = zIndexCounter;
            win.classList.remove('minimized');
            const winData = openWindows.find(w => w.id === id);
            if(winData) winData.state = 'normal';
            updateTaskbar();
            updateTaskbarVisibility();
        }

        function minimizeWindow(id) {
             const win = document.getElementById(id);
             win.classList.add('minimized');
             const winData = openWindows.find(w => w.id === id);
             if(winData) winData.state = 'minimized';
             updateTaskbar();
             updateTaskbarVisibility();
        }

        function toggleMaximize(id) {
            const win = document.getElementById(id);
            const winData = openWindows.find(w => w.id === id);
            
            if (win.classList.contains('maximized')) {
                // restore
                win.classList.remove('maximized');
                if(win.classList.contains('fullscreened')) {
                    // if fullscreened because of setting, remove special fullscreen
                    win.classList.remove('fullscreened');
                    // restore saved dims (stored earlier)
                    win.style.left = winData.savedDims.left;
                    win.style.top = winData.savedDims.top;
                    win.style.width = winData.savedDims.width;
                    win.style.height = winData.savedDims.height;
                } else {
                    win.style.left = winData.savedDims.left;
                    win.style.top = winData.savedDims.top;
                    win.style.width = winData.savedDims.width;
                    win.style.height = winData.savedDims.height;
                }
                winData.state = 'normal';
            } else {
                // save dims then maximize
                winData.savedDims = { left: win.style.left, top: win.style.top, width: win.style.width, height: win.style.height };
                win.classList.add('maximized');
                winData.state = 'maximized';

                // If user enabled "Disappear in fullscreen" we will go fully fullscreen,
                // hide the taskbar and expand the window to full viewport (100vh)
                const hideFullscreen = localStorage.getItem('crunch_taskbar_hide_fullscreen') === 'true';
                if(hideFullscreen) {
                    win.classList.add('fullscreened');
                    // apply the fullscreen class styles (CSS handles overrides)
                    // Hide taskbar visually / disable interactions
                    const tb = document.querySelector('.taskbar');
                    if(tb) tb.classList.add('hidden-fullscreen');
                }
            }

            // Ensure we update taskbar display state based on current windows
            updateTaskbarVisibility();
        }

        function closeWindow(id) {
            const win = document.getElementById(id);
            win.style.opacity = '0';
            win.style.transform = 'scale(0.9)';
            if (windowCleanupCallbacks[id]) {
                windowCleanupCallbacks[id]();
                delete windowCleanupCallbacks[id];
            }
            setTimeout(() => {
                win.remove();
                openWindows = openWindows.filter(w => w.id !== id);
                updateTaskbar();
                updateTaskbarVisibility();
            }, 200);
        }

        function setupDraggable(id) {
            const win = document.getElementById(id);
            const handle = win.querySelector('.ondrag-handle');
            let isDragging = false;
            let startX, startY, initialLeft, initialTop;

            handle.onmousedown = (e) => {
                if(win.classList.contains('maximized')) return;
                focusWindow(id);
                isDragging = true;
                startX = e.clientX;
                startY = e.clientY;
                initialLeft = win.offsetLeft;
                initialTop = win.offsetTop;
                win.style.transition = 'none';
                
                document.onmousemove = (e) => {
                    if (!isDragging) return;
                    win.style.left = (initialLeft + (e.clientX - startX)) + "px";
                    win.style.top = (initialTop + (e.clientY - startY)) + "px";
                };

                document.onmouseup = () => {
                    isDragging = false;
                    document.onmousemove = null;
                    win.style.transition = '';
                };
            };
        }

        function applyCloak(key) {
            const preset = CLOAK_PRESETS[key] || CLOAK_PRESETS.none;
            document.title = preset.title;
            const link = document.getElementById('favicon');
            link.href = preset.icon;
            localStorage.setItem('crunch_cloak', key);
        }

        function changeTheme(theme) {
            document.body.className = `theme-${theme}`;
            localStorage.setItem('crunch_theme', theme);
            sendNotification('System', `Theme changed to ${theme}`, 'palette');
        }

        function changeBackground(url) {
            if(!url) return;
            document.documentElement.style.setProperty('--desktop-bg', `url('${url}')`);
            localStorage.setItem('crunch_bg', url);
        }

        function setBackgroundBrightness(val) {
            const opacity = 1 - (val / 100);
            document.documentElement.style.setProperty('--bg-overlay', `rgba(0, 0, 0, ${opacity})`);
            localStorage.setItem('crunch_brightness', opacity);
        }

        async function handleWallpaperUpload(winId) {
            const file = document.getElementById(`wp-file-${winId}`).files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                changeBackground(e.target.result);
                sendNotification('Wallpaper', 'Custom image applied');
            };
            reader.readAsDataURL(file);
        }

        // New: apply OS Design (Default / Windows 10 / Mac OS)
        function applyOSDesign(design) {
            // clear existing os classes
            document.body.classList.remove('os-win10','os-macos','os-default');
            if(design === 'win10') document.body.classList.add('os-win10');
            else if(design === 'mac') document.body.classList.add('os-macos');
            else document.body.classList.add('os-default');
            localStorage.setItem('crunch_os_design', design);
            sendNotification('System', `OS Design: ${design === 'win10' ? 'Windows 10' : design === 'mac' ? 'Mac-OS' : "Crunch OS"} selected`, 'monitor');
            // Some UI elements might need reflow
            updateTaskbarVisibility();
        }

        // New: update taskbar visibility depending on user setting and window states
        function updateTaskbarVisibility() {
            const tb = document.querySelector('.taskbar');
            if(!tb) return;
            const hideFullscreen = localStorage.getItem('crunch_taskbar_hide_fullscreen') === 'true';
            // If any window has .fullscreened or the browser fullscreen setting is active, hide
            const anyFullscreen = !!document.querySelector('.window.fullscreened');
            if(hideFullscreen && anyFullscreen) tb.classList.add('hidden-fullscreen');
            else tb.classList.remove('hidden-fullscreen');
        }

        function setTaskbarDisappearInFullscreen(val) {
            localStorage.setItem('crunch_taskbar_hide_fullscreen', val ? 'true' : 'false');
            sendNotification('Taskbar', `Disappear in fullscreen ${val ? 'enabled' : 'disabled'}`, 'layout');
            updateTaskbarVisibility();
        }

        function loadSettingsPage(winId, page) {
            const content = document.getElementById(`settings-content-${winId}`);
            if(!content) return;

            document.querySelectorAll('.settings-nav-item').forEach(el => el.classList.remove('active'));
            const activeNav = document.querySelector(`[data-page="${page}"]`);
            if(activeNav) activeNav.classList.add('active');

            let html = '';
            if(page === 'appearance') {
                html = `
                <div class="space-y-6">
                    <div>
                        <h3 class="text-lg font-bold mb-4">System Accent</h3>
                        <div class="flex gap-4">
                            <button onclick="changeTheme('default')" class="w-10 h-10 rounded-full bg-cyan-400 border-2 border-white/20"></button>
                            <button onclick="changeTheme('crimson')" class="w-10 h-10 rounded-full bg-red-500 border-2 border-white/20"></button>
                            <button onclick="changeTheme('emerald')" class="w-10 h-10 rounded-full bg-emerald-500 border-2 border-white/20"></button>
                            <button onclick="changeTheme('gold')" class="w-10 h-10 rounded-full bg-amber-500 border-2 border-white/20"></button>
                            <button onclick="changeTheme('void')" class="w-10 h-10 rounded-full bg-white border-2 border-white/20"></button>
                        </div>
                    </div>
                </div>`;
            } else if(page === 'cloak') {
                html = `
                <div class="space-y-4">
                    <h3 class="text-lg font-bold">Tab Cloaking</h3>
                    <p class="text-xs text-gray-400">Change how this tab looks in your browser history and tab bar.</p>
                    <div class="grid grid-cols-2 gap-3">
                        ${Object.keys(CLOAK_PRESETS).map(key => `
                            <button onclick="applyCloak('${key}')" class="flex items-center gap-3 p-3 bg-white/5 hover:bg-white/10 rounded-xl transition-all text-left">
                                <img src="${CLOAK_PRESETS[key].icon}" class="w-5 h-5">
                                <span class="text-sm capitalize">${key}</span>
                            </button>
                        `).join('')}
                    </div>
                </div>`;
            } else if(page === 'custom-apps') {
                const customKeys = Object.keys(APPS).filter(k => APPS[k].isCustom);
                html = `
                <div class="space-y-4">
                    <h3 class="text-lg font-bold">Manage Custom Apps</h3>
                    ${customKeys.length === 0 ? '<p class="text-gray-500 text-sm italic">No custom apps installed yet.</p>' : ''}
                    <div class="space-y-2">
                        ${customKeys.map(key => `
                            <div class="flex items-center justify-between p-3 bg-white/5 rounded-xl border border-white/5">
                                <div class="flex items-center gap-3">
                                    <div class="p-2 rounded-lg ${APPS[key].bg}">
                                        ${APPS[key].customIcon ? `<img src="${APPS[key].customIcon}" class="w-4 h-4 rounded-sm">` : `<i data-lucide="${APPS[key].icon}" class="w-4 h-4 ${APPS[key].color}"></i>`}
                                    </div>
                                    <span class="text-sm font-medium">${APPS[key].name}</span>
                                </div>
                                <div class="flex gap-2">
                                    <button onclick="deleteApp('${key}', '${winId}')" class="p-2 hover:bg-red-500/20 text-red-400 rounded-lg transition-colors"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>`;
            } else if(page === 'taskbar') {
                // new taskbar options panel
                const hideFs = localStorage.getItem('crunch_taskbar_hide_fullscreen') === 'true';
                html = `
                <div class="space-y-6">
                    <h3 class="text-lg font-bold">Taskbar</h3>
                    <p class="text-sm text-gray-400">Customize how the taskbar behaves. These options let apps use more screen real estate when needed.</p>
                    <div class="mt-4 p-4 bg-white/5 rounded-xl border border-white/5">
                        <div class="flex items-center justify-between">
                            <div>
                                <div class="font-bold">Disappear in fullscreen</div>
                                <div class="text-xs text-gray-400">When enabled, the taskbar will hide automatically when an app is fullscreened/maximized to give apps the full viewport. The taskbar will reappear when you restore the app.</div>
                            </div>
                            <div>
                                <label class="switch">
                                    <input type="checkbox" id="taskbar-hide-fs-checkbox" ${hideFs ? 'checked' : ''} onchange="setTaskbarDisappearInFullscreen(this.checked)">
                                    <span class="ml-2 text-sm">${hideFs ? 'On' : 'Off'}</span>
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="text-xs text-gray-500">Note: This does not remove taskbar functionality â€” it only hides it visually while apps are fullscreen.</div>
                </div>`;
            } else if(page === 'osdesign') {
                const current = localStorage.getItem('crunch_os_design') || 'default';
                html = `
                <div class="space-y-6">
                    <h3 class="text-lg font-bold">OS Design</h3>
                    <p class="text-sm text-gray-400">Choose an overall UI design. This will apply cosmetic changes to the taskbar and window chrome while keeping all Crunch OS functionality intact.</p>
                    <div class="mt-4 grid grid-cols-3 gap-4">
                        <div class="p-4 bg-white/5 rounded-xl text-center">
                            <div class="text-sm font-bold mb-2">Default (Crunch OS)</div>
                            <div class="text-xs text-gray-400 mb-3">Keeps the signature Crunch look.</div>
                            <button onclick="applyOSDesign('default')" class="px-3 py-1 rounded bg-white/6">Select</button>
                            ${current === 'default' ? '<div class="text-xs text-green-400 mt-2 font-bold">Active</div>' : ''}
                        </div>
                        <div class="p-4 bg-white/5 rounded-xl text-center">
                            <div class="text-sm font-bold mb-2">Windows 10</div>
                            <div class="text-xs text-gray-400 mb-3">Taskbar and chrome mimic Windows 10 appearance.</div>
                            <button onclick="applyOSDesign('win10')" class="px-3 py-1 rounded bg-white/6">Select</button>
                            ${current === 'win10' ? '<div class="text-xs text-green-400 mt-2 font-bold">Active</div>' : ''}
                        </div>
                        <div class="p-4 bg-white/5 rounded-xl text-center">
                            <div class="text-sm font-bold mb-2">Mac-OS</div>
                            <div class="text-xs text-gray-400 mb-3">Dock-like taskbar and mac-like window chrome.</div>
                            <button onclick="applyOSDesign('mac')" class="px-3 py-1 rounded bg-white/6">Select</button>
                            ${current === 'mac' ? '<div class="text-xs text-green-400 mt-2 font-bold">Active</div>' : ''}
                        </div>
                    </div>
                </div>`;
            }
            content.innerHTML = html;
            lucide.createIcons();
        }

        function deleteApp(key, winId) {
            if(!confirm("Are you sure you want to delete this app?")) return;
            const saved = localStorage.getItem('crunch_custom_apps');
            if(saved) {
                let customApps = JSON.parse(saved);
                delete customApps[key];
                localStorage.setItem('crunch_custom_apps', JSON.stringify(customApps));
                delete APPS[key];
                renderDesktopIcons();
                renderStartMenu();
                loadSettingsPage(winId, 'custom-apps');
                sendNotification('System', 'App removed successfully.', 'trash-2');
            }
        }

        function getAppContent(appKey, winId) {
            const app = APPS[appKey];
            if(app && app.isCustom) {
                return `<iframe srcdoc='${app.html.replace(/'/g, "&apos;")}' class="w-full h-full border-none bg-white"></iframe>`;
            }

            switch(appKey) {
                case 'settings':
                    // remastered settings UI - Windows 10 like layout but keeping existing pages
                    return `
                    <div class="h-full settings-shell">
                        <div class="settings-left">
                            <div class="section">System</div>
                            <div class="settings-category settings-nav-item active" data-page="appearance" onclick="loadSettingsPage('${winId}', 'appearance')"><i data-lucide="palette" class="w-4"></i> Appearance</div>
                            <div class="settings-category settings-nav-item" data-page="taskbar" onclick="loadSettingsPage('${winId}', 'taskbar')"><i data-lucide="layout" class="w-4"></i> Taskbar</div>
                            <div class="settings-category settings-nav-item" data-page="cloak" onclick="loadSettingsPage('${winId}', 'cloak')"><i data-lucide="shield" class="w-4"></i> Cloaking</div>
                            <div class="section">Apps & Personalization</div>
                            <div class="settings-category settings-nav-item" data-page="custom-apps" onclick="loadSettingsPage('${winId}', 'custom-apps')"><i data-lucide="package" class="w-4"></i> Custom Apps</div>
                            <div class="settings-category settings-nav-item" data-page="osdesign" onclick="loadSettingsPage('${winId}', 'osdesign')"><i data-lucide="monitor" class="w-4"></i> OS Design</div>
                            <div style="flex:1"></div>
                            <div class="text-xs text-gray-400">Crunch OS Settings</div>
                        </div>
                        <div class="settings-right" id="settings-content-${winId}"></div>
                    </div>`;
                case 'browser':
                    return `<iframe src="${APPS.browser.url}" class="w-full h-full border-none bg-white"></iframe>`;
                case 'gameshub':
                    // New: Games Hub opens the provided games hub link in an iframe
                    return `<iframe src="${APPS.gameshub.url}" class="w-full h-full border-none bg-white"></iframe>`;
                case 'music':
                    return `
                    <div class="h-full flex flex-col bg-black text-gray-400 font-sans">
                        <div class="flex-grow flex overflow-hidden">
                            <div class="w-60 bg-black p-6 flex flex-col gap-6">
                                <div class="flex items-center gap-2 text-white font-bold text-xl">
                                    <i data-lucide="music" class="text-green-500 w-8 h-8"></i> Spotify
                                </div>
                                <nav class="flex flex-col gap-4 text-sm font-bold">
                                    <button onclick="switchMusicView('${winId}', 'home')" class="spotify-sidebar-item active flex items-center gap-4 transition-colors"><i data-lucide="home"></i> Home</button>
                                    <button onclick="switchMusicView('${winId}', 'library')" class="spotify-sidebar-item flex items-center gap-4 transition-colors"><i data-lucide="library"></i> Your Library</button>
                                    <button onclick="document.getElementById('audio-upload-${winId}').click()" class="spotify-sidebar-item flex items-center gap-4 transition-colors"><i data-lucide="plus-square"></i> Upload Song</button>
                                    <input type="file" id="audio-upload-${winId}" accept="audio/mp3" class="hidden" multiple>
                                </nav>
                                <div class="h-[1px] bg-white/10"></div>
                                <div class="flex flex-col gap-3 overflow-y-auto" id="album-nav-${winId}">
                                    <button onclick="createNewAlbum('${winId}')" class="text-xs hover:text-white flex items-center gap-2"><i data-lucide="plus" class="w-3"></i> Create Album</button>
                                </div>
                            </div>
                            <div class="flex-grow bg-gradient-to-b from-[#1e1e1e] to-[#121212] p-8 overflow-y-auto" id="music-main-${winId}">
                                <div id="view-home-${winId}">
                                    <h1 class="text-3xl font-black text-white mb-8">Welcome to Crunch Music</h1>
                                    <div class="grid grid-cols-2 lg:grid-cols-3 gap-4" id="home-playlists-${winId}"></div>
                                </div>
                            </div>
                        </div>
                        <div class="h-24 bg-[#181818] border-t border-white/5 px-4 flex items-center justify-between">
                            <div class="flex items-center gap-4 w-1/3">
                                <div class="w-14 h-14 bg-white/5 rounded-md flex items-center justify-center" id="now-playing-img-${winId}"><i data-lucide="music" class="w-6 text-gray-600"></i></div>
                                <div class="flex flex-col">
                                    <span class="text-sm text-white font-medium" id="now-playing-title-${winId}">Not Playing</span>
                                    <span class="text-xs" id="now-playing-artist-${winId}">Crunch OS Player</span>
                                </div>
                            </div>
                            <div class="flex flex-col items-center gap-2 w-1/3">
                                <div class="flex items-center gap-6">
                                    <button class="hover:text-white transition-colors"><i data-lucide="shuffle" class="w-4"></i></button>
                                    <button class="hover:text-white transition-colors"><i data-lucide="skip-back" class="w-5 fill-current"></i></button>
                                    <button onclick="toggleAudio('${winId}')" class="w-8 h-8 rounded-full bg-white text-black flex items-center justify-center hover:scale-105 transition-all"><i data-lucide="play" id="play-btn-icon-${winId}" class="w-5 fill-current"></i></button>
                                    <button class="hover:text-white transition-colors"><i data-lucide="skip-forward" class="w-5 fill-current"></i></button>
                                    <button class="hover:text-white transition-colors"><i data-lucide="repeat" class="w-4"></i></button>
                                </div>
                                <div class="w-full flex items-center gap-2 text-[10px]">
                                    <span id="audio-current-${winId}">0:00</span>
                                    <div class="flex-grow h-1 bg-white/10 rounded-full group cursor-pointer relative" onclick="seekAudio(event, '${winId}')">
                                        <div class="absolute top-0 left-0 h-full bg-white group-hover:bg-green-500 rounded-full" id="audio-progress-${winId}"></div>
                                    </div>
                                    <span id="audio-duration-${winId}">0:00</span>
                                </div>
                            </div>
                            <div class="flex items-center justify-end gap-3 w-1/3">
                                <i data-lucide="volume-2" class="w-4"></i>
                                <div class="w-24 h-1 bg-white/10 rounded-full"><div class="w-2/3 h-full bg-white hover:bg-green-500 rounded-full"></div></div>
                            </div>
                        </div>
                        <audio id="music-engine-${winId}"></audio>
                    </div>`;
                case 'terminal':
                    return `<div class="p-4 h-full flex flex-col terminal-font bg-black/90 text-green-400 overflow-auto" id="term-out-${winId}"></div><div class="flex bg-black/90 border-t border-white/5 p-2"><span class="text-green-400 mr-2">crunch@os:~$</span><input type="text" id="term-in-${winId}" class="bg-transparent border-none outline-none text-green-400 flex-grow terminal-font" autofocus spellcheck="false"></div>`;
                case 'calculator':
                    return `<div class="p-6 grid grid-cols-4 gap-2 h-full bg-black/40"><div class="col-span-4 bg-black/50 p-4 rounded-xl text-right text-2xl font-mono mb-4 border border-white/10" id="calc-display-${winId}">0</div>${['7','8','9','/','4','5','6','*','1','2','3','-','C','0','=','+'].map(key => `<button onclick="handleCalc('${winId}', '${key}')" class="calc-btn text-lg font-bold">${key}</button>`).join('')}</div>`;
                case 'notepad':
                    return `<textarea class="w-full h-full bg-transparent p-6 outline-none resize-none text-sm leading-relaxed" placeholder="Start typing your thoughts..." oninput="localStorage.setItem('crunch_notes', this.value)">${systemNotes}</textarea>`;
                case 'wallpapers':
                    return `
                    <div class="p-8 h-full overflow-y-auto">
                        <div class="flex justify-between items-end mb-8">
                            <div><h2 class="text-3xl font-black mb-2">Personalization</h2><p class="text-gray-400 text-sm">Choose how your workspace looks.</p></div>
                            <div class="flex gap-4 items-center">
                                <span class="text-xs font-bold text-gray-500 uppercase tracking-widest">Brightness</span>
                                <input type="range" min="0" max="100" value="50" oninput="setBackgroundBrightness(this.value)" class="accent-cyan-400">
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            <div class="col-span-full border-b border-white/10 pb-4 flex items-center justify-between">
                                <h3 class="font-bold flex items-center gap-2"><i data-lucide="image" class="w-4"></i> Static Backgrounds</h3>
                                <button onclick="document.getElementById('wp-file-${winId}').click()" class="text-xs bg-white/10 hover:bg-white/20 px-3 py-1.5 rounded-lg transition-colors flex items-center gap-2">
                                    <i data-lucide="upload" class="w-3"></i> Upload Custom
                                </button>
                                <input type="file" id="wp-file-${winId}" class="hidden" accept="image/*" onchange="handleWallpaperUpload('${winId}')">
                            </div>
                            ${DEFAULT_WALLPAPERS.filter(w => w.type === 'static').map(wp => `
                                <div onclick="changeBackground('${wp.url}?q=80&w=2072&auto=format&fit=crop')" class="group relative aspect-video rounded-2xl overflow-hidden cursor-pointer border border-white/10 hover:border-cyan-400/50 transition-all">
                                    <img src="${wp.url}?q=40&w=400" class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-500">
                                    <div class="absolute inset-0 bg-gradient-to-t from-black/60 to-transparent opacity-0 group-hover:opacity-100 transition-opacity p-4 flex items-end">
                                        <span class="text-xs font-bold">${wp.name}</span>
                                    </div>
                                </div>
                            `).join('')}
                            <div class="col-span-full border-b border-white/10 pb-4 mt-8"><h3 class="font-bold flex items-center gap-2"><i data-lucide="sparkles" class="w-4"></i> Animated Backgrounds</h3></div>
                            ${DEFAULT_WALLPAPERS.filter(w => w.type === 'gif').map(wp => `
                                <div onclick="changeBackground('${wp.url}')" class="group relative aspect-video rounded-2xl overflow-hidden cursor-pointer border border-white/10 hover:border-cyan-400/50 transition-all">
                                    <img src="${wp.url}" class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-500">
                                    <div class="absolute inset-0 bg-gradient-to-t from-black/60 to-transparent opacity-0 group-hover:opacity-100 transition-opacity p-4 flex items-end">
                                        <span class="text-xs font-bold">${wp.name}</span>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>`;
                case 'htmlviewer':
                    return `
                    <div class="h-full flex flex-col">
                        <div class="p-4 border-b border-white/10 flex gap-4 bg-black/20">
                            <input type="text" id="html-url-${winId}" placeholder="Enter website URL or custom HTML..." class="flex-grow bg-white/5 border border-white/10 rounded-lg px-4 py-1.5 text-sm outline-none focus:border-cyan-500/50">
                            <button onclick="renderHTML('${winId}')" class="bg-cyan-500 hover:bg-cyan-600 text-black px-4 py-1.5 rounded-lg text-sm font-bold transition-colors">Launch</button>
                        </div>
                        <div class="flex-grow" id="html-frame-container-${winId}">
                            <iframe id="html-frame-${winId}" class="w-full h-full bg-white border-none"></iframe>
                        </div>
                    </div>`;
                case 'custominstaller':
                    return `
                    <div class="p-10 max-w-2xl mx-auto h-full overflow-y-auto">
                        <div class="text-center mb-10">
                            <div class="w-16 h-16 bg-cyan-500/20 text-cyan-400 rounded-3xl flex items-center justify-center mx-auto mb-4">
                                <i data-lucide="package-plus" class="w-8 h-8"></i>
                            </div>
                            <h2 class="text-3xl font-black mb-2">Custom App Installer</h2>
                            <p class="text-gray-400">Package your own web tools directly into Crunch OS.</p>
                        </div>
                        <div class="glass p-8 rounded-3xl border-white/10 space-y-6">
                            <div class="grid grid-cols-2 gap-6">
                                <div class="space-y-2">
                                    <label class="text-xs font-bold text-gray-500 uppercase">App Name</label>
                                    <input type="text" id="custom-name-${winId}" placeholder="My Cool Tool" class="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-2.5 text-sm outline-none focus:border-cyan-500/50">
                                </div>
                                <div class="space-y-2">
                                    <label class="text-xs font-bold text-gray-500 uppercase">Lucide Icon ID</label>
                                    <input type="text" id="custom-icon-${winId}" placeholder="zap, box, anchor..." class="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-2.5 text-sm outline-none focus:border-cyan-500/50">
                                </div>
                            </div>
                            <div class="space-y-2">
                                <label class="text-xs font-bold text-gray-500 uppercase">HTML / Embedded Source</label>
                                <textarea id="custom-html-${winId}" placeholder="<div class='p-10'><h1>Hello World</h1></div>" class="w-full h-40 bg-white/5 border border-white/10 rounded-xl px-4 py-3 text-sm outline-none focus:border-cyan-500/50 font-mono"></textarea>
                            </div>
                            <button onclick="installCustomApp('${winId}')" class="w-full bg-cyan-500 hover:bg-cyan-600 text-black py-4 rounded-2xl font-black transition-all transform active:scale-[0.98]">INSTALL PACKAGE</button>
                        </div>
                    </div>`;
                case 'snake':
                    return `<canvas id="snake-canvas-${winId}" width="560" height="340" class="bg-black/40 mx-auto block mt-4 rounded-xl border border-white/10"></canvas><div class="flex justify-between p-4 px-10 text-sm font-bold text-cyan-400"><span>SCORE: <span id="snake-score-${winId}">0</span></span><span>HIGHSCORE: <span id="snake-high-${winId}">0</span></span></div>`;
                case 'zombie':
                    return `<div class="relative"><canvas id="zombie-canvas-${winId}" width="400" height="300" class="bg-[#1a3300] mx-auto block mt-4 rounded-xl border-4 border-[#2c5e1a]"></canvas><div class="absolute top-8 left-1/2 -translate-x-1/2 flex gap-4 font-black"><span class="bg-black/60 px-3 py-1 rounded text-yellow-400">SUN: <span id="zombie-sun-${winId}">100</span></span></div><div class="p-4 flex justify-center gap-4"><button onclick="buyPlant('${winId}', 'pea')" class="bg-[#2ecc71] text-black px-4 py-2 rounded-lg font-bold hover:scale-105 transition-transform">PEASHOOTER (50)</button></div></div>`;
                case 'files':
                    return `
                    <div class="h-full flex divide-x divide-white/10">
                        <div class="w-48 p-4 flex flex-col gap-1">
                            <div class="text-[10px] font-bold text-gray-500 uppercase tracking-widest px-2 mb-2">Favorites</div>
                            <button onclick="renderFiles('${winId}', 'root')" class="flex items-center gap-3 p-2.5 rounded-lg text-sm bg-white/10 text-cyan-400 font-bold"><i data-lucide="layout-grid" class="w-4"></i> System Drive</button>
                            <button class="flex items-center gap-3 p-2.5 rounded-lg text-sm text-gray-400 hover:bg-white/5"><i data-lucide="clock" class="w-4"></i> Recent</button>
                        </div>
                        <div class="flex-grow p-6 flex flex-col gap-6">
                            <div class="flex items-center gap-4 text-xs font-bold text-gray-400 uppercase tracking-widest border-b border-white/5 pb-4">
                                <i data-lucide="chevron-right" class="w-3"></i> System (C:) <i data-lucide="chevron-right" class="w-3"></i> Apps
                            </div>
                            <div class="grid grid-cols-4 md:grid-cols-6 gap-6" id="files-grid-${winId}"></div>
                        </div>
                    </div>`;
                default:
                    return `<div class="p-10 text-center"><div class="text-6xl mb-4">ðŸ—ï¸</div><h2 class="text-2xl font-bold">App Under Construction</h2><p class="text-gray-400">This feature will be available in the next system update.</p></div>`;
            }
        }

        function renderDesktopIcons() {
            const container = document.getElementById('desktop-icons');
            container.innerHTML = '';
            Object.keys(APPS).forEach(key => {
                const app = APPS[key];
                if(app.hidden) return;
                const icon = document.createElement('div');
                icon.className = 'w-24 h-24 flex flex-col items-center justify-center gap-2 rounded-2xl hover:bg-white/10 cursor-pointer transition-all group active:scale-95';
                icon.onclick = () => launchApp(key);
                icon.innerHTML = `
                    <div class="w-14 h-14 ${app.bg} rounded-[18px] flex items-center justify-center app-icon-shadow group-hover:scale-110 transition-transform glossy-finish border border-white/5">
                        ${app.isCustom && app.customIcon ? `<img src="${app.customIcon}" class="w-7 h-7 rounded-sm">` : `<i data-lucide="${app.icon}" class="w-7 h-7 ${app.color}"></i>`}
                    </div>
                    <span class="text-[11px] font-medium text-white/90 drop-shadow-lg text-center leading-tight px-1">${app.name}</span>
                `;
                container.appendChild(icon);
            });
            lucide.createIcons();
        }

        function renderStartMenu() {
            const grid = document.getElementById('start-menu-grid');
            grid.innerHTML = '';
            Object.keys(APPS).forEach(key => {
                const app = APPS[key];
                const item = document.createElement('button');
                item.onclick = () => { launchApp(key); toggleStartMenu(); };
                item.className = 'flex flex-col items-center gap-2 p-3 rounded-2xl hover:bg-white/10 transition-all';
                item.innerHTML = `
                    <div class="w-10 h-10 ${app.bg} rounded-xl flex items-center justify-center">
                        ${app.isCustom && app.customIcon ? `<img src="${app.customIcon}" class="w-5 h-5 rounded-sm">` : `<i data-lucide="${app.icon}" class="w-5 h-5 ${app.color}"></i>`}
                    </div>
                    <span class="text-[10px] font-medium truncate w-full">${app.name}</span>
                `;
                grid.appendChild(item);
            });
            lucide.createIcons();
        }

        function updateTaskbar() {
            const container = document.getElementById('taskbar-apps');
            container.innerHTML = '';
            
            openWindows.forEach(win => {
                const app = APPS[win.appKey];
                const btn = document.createElement('button');
                btn.className = `taskbar-item p-2.5 rounded-xl transition-all flex items-center justify-center ${win.state !== 'minimized' ? 'bg-white/10 border-white/20 border running' : 'opacity-60'}`;
                btn.onclick = () => win.state === 'minimized' ? focusWindow(win.id) : minimizeWindow(win.id);
                btn.innerHTML = app.isCustom && app.customIcon ? `<img src="${app.customIcon}" class="w-6 h-6">` : `<i data-lucide="${app.icon}" class="w-6 h-6 ${app.color}"></i>`;
                container.appendChild(btn);
            });
            lucide.createIcons();
        }

        function toggleStartMenu() {
            document.getElementById('start-menu').classList.toggle('hidden-menu');
        }

        function startClock() {
            const update = () => {
                const now = new Date();
                document.getElementById('clock-time').textContent = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                document.getElementById('clock-date').textContent = now.toLocaleDateString([], { month: 'short', day: 'numeric', year: 'numeric' });
            };
            setInterval(update, 1000); update();
        }

        function sendNotification(title, text, icon = 'bell') {
            const area = document.getElementById('notification-area');
            const toast = document.createElement('div');
            toast.className = 'toast flex items-start gap-4 glossy-finish';
            toast.innerHTML = `<div class="p-2 bg-white/10 rounded-lg accent-color"><i data-lucide="${icon}" class="w-5 h-5"></i></div><div><div class="font-bold text-sm">${title}</div><div class="text-xs text-gray-400">${text}</div></div>`;
            area.appendChild(toast);
            document.getElementById('sound-notify').play().catch(() => {});
            lucide.createIcons();
            setTimeout(() => { toast.style.animation = 'slideOutRight 0.3s ease forwards'; setTimeout(() => toast.remove(), 300); }, 4000);
        }

        function handleCalc(id, key) {
            const display = document.getElementById(`calc-display-${id}`);
            if(key === 'C') display.textContent = '0';
            else if(key === '=') { try { display.textContent = eval(display.textContent); } catch(e) { display.textContent = 'Error'; } }
            else display.textContent = display.textContent === '0' ? key : display.textContent + key;
        }

        function initSnakeGame(winId) {
            const canvas = document.getElementById(`snake-canvas-${winId}`);
            const ctx = canvas.getContext('2d');
            const scoreEl = document.getElementById(`snake-score-${winId}`);
            const highEl = document.getElementById(`snake-high-${winId}`);
            let snake = [{x: 10, y: 10}];
            let food = {x: 5, y: 5};
            let dx = 1, dy = 0, score = 0, high = localStorage.getItem('snake_high') || 0;
            highEl.textContent = high;

            const loop = setInterval(() => {
                const head = {x: snake[0].x + dx, y: snake[0].y + dy};
                if(head.x < 0 || head.x >= 28 || head.y < 0 || head.y >= 17 || snake.find(s => s.x === head.x && s.y === head.y)) {
                    snake = [{x: 10, y: 10}]; dx = 1; dy = 0; score = 0; scoreEl.textContent = 0;
                } else {
                    snake.unshift(head);
                    if(head.x === food.x && head.y === food.y) {
                        score += 10; scoreEl.textContent = score;
                        if(score > high) { high = score; highEl.textContent = high; localStorage.setItem('snake_high', high); }
                        food = {x: Math.floor(Math.random()*28), y: Math.floor(Math.random()*17)};
                    } else snake.pop();
                }
                ctx.fillStyle = '#000'; ctx.fillRect(0,0,560,340);
                ctx.fillStyle = '#ff4d4d'; ctx.fillRect(food.x*20, food.y*20, 18, 18);
                ctx.fillStyle = '#00f2ff'; snake.forEach(s => ctx.fillRect(s.x*20, s.y*20, 18, 18));
            }, 100);

            const handleKeys = (e) => {
                if(e.key === 'ArrowUp' && dy === 0) { dx = 0; dy = -1; }
                if(e.key === 'ArrowDown' && dy === 0) { dx = 0; dy = 1; }
                if(e.key === 'ArrowLeft' && dx === 0) { dx = -1; dy = 0; }
                if(e.key === 'ArrowRight' && dx === 0) { dx = 1; dy = 0; }
            };
            window.addEventListener('keydown', handleKeys);
            windowCleanupCallbacks[winId] = () => { clearInterval(loop); window.removeEventListener('keydown', handleKeys); };
        }

        function initZombieGame(winId) {
            const canvas = document.getElementById(`zombie-canvas-${winId}`);
            const ctx = canvas.getContext('2d');
            const sunEl = document.getElementById(`zombie-sun-${winId}`);
            let sun = 100, plants = [], zombies = [], projectiles = [];

            const loop = setInterval(() => {
                ctx.fillStyle = '#1a3300'; ctx.fillRect(0,0,400,300);
                sun += 0.2; sunEl.textContent = Math.floor(sun);
                if(Math.random() < 0.015) zombies.push({x: 400, y: Math.floor(Math.random()*7)*40, hp: 5});
                plants.forEach(p => {
                    ctx.fillStyle = '#2ecc71'; ctx.fillRect(p.x+10, p.y+10, 20, 20);
                    p.timer++; if(p.timer > 60) { projectiles.push({x: p.x+30, y: p.y+20}); p.timer = 0; }
                });
                zombies.forEach((z, i) => {
                    ctx.fillStyle = '#9b59b6'; ctx.fillRect(z.x, z.y+5, 30, 30);
                    z.x -= 0.5; if(z.x < 0) { zombies = []; plants = []; sun = 100; }
                });
                projectiles.forEach((p, pi) => {
                    ctx.fillStyle = '#f1c40f'; ctx.beginPath(); ctx.arc(p.x, p.y, 4, 0, Math.PI*2); ctx.fill();
                    p.x += 4;
                    zombies.forEach((z, zi) => {
                        if(p.x > z.x && p.x < z.x+30 && p.y > z.y && p.y < z.y+30) {
                            z.hp--; projectiles.splice(pi, 1);
                            if(z.hp <= 0) zombies.splice(zi, 1);
                        }
                    });
                });
            }, 1000/60);

            canvas.onclick = (e) => {
                const rect = canvas.getBoundingClientRect();
                const x = Math.floor((e.clientX - rect.left)/40)*40;
                const y = Math.floor((e.clientY - rect.top)/40)*40;
                if(sun >= 50 && !plants.find(p => p.x === x && p.y === y)) {
                    plants.push({x, y, timer: 0}); sun -= 50;
                }
            };
            windowCleanupCallbacks[winId] = () => clearInterval(loop);
        }

        function initTerminal(winId) {
            const out = document.getElementById(`term-out-${winId}`);
            const input = document.getElementById(`term-in-${winId}`);
            const print = (text, color = 'text-green-400') => {
                const line = document.createElement('div');
                line.className = `mb-1 ${color}`;
                line.textContent = text;
                out.appendChild(line);
                out.scrollTop = out.scrollHeight;
            };

            print("Crunch OS [Version 3.1.0]");
            print("(c) 2026 Crunch OS Corporation. All rights reserved.");
            print("");
            print("Type 'help' to see available commands.");

            input.onkeydown = (e) => {
                if(e.key === 'Enter') {
                    const cmd = input.value.trim().toLowerCase();
                    print(`crunch@os:~$ ${input.value}`);
                    input.value = '';
                    
                    if(cmd === 'help') {
                        print("Available commands: help, clear, apps, cls, neofetch, system, whoami, ping, ver");
                    } else if(cmd === 'clear' || cmd === 'cls') {
                        out.innerHTML = '';
                    } else if(cmd === 'apps') {
                        print("System apps: " + Object.keys(APPS).join(", "));
                    } else if(cmd === 'neofetch') {
                        print("Crunch OS V3.1", "text-cyan-400");
                        print("------------");
                        print("Kernel: WebKit V8");
                        print("Shell: JavaScript ES2024");
                        print("Resolution: " + window.innerWidth + "x" + window.innerHeight);
                        print("DE: GlassBlur UI");
                        print("Theme: Crimson/Emerald/Gold");
                    } else if(cmd === 'whoami') {
                        print("crunch_user_admin");
                    } else if(cmd === 'ping') {
                        print("Pinging crunch_server [127.0.0.1] with 32 bytes of data:");
                        setTimeout(() => print("Reply from 127.0.0.1: bytes=32 time=4ms TTL=128"), 500);
                    } else if(cmd === 'ver') {
                        print("Crunch OS Core System v3.1.0 [Stable Release]");
                    } else {
                        print(`Command '${cmd}' not found.`, 'text-red-400');
                    }
                }
            };
        }

        function installCustomApp(winId) {
            const name = document.getElementById(`custom-name-${winId}`).value;
            const icon = document.getElementById(`custom-icon-${winId}`).value || 'package';
            const html = document.getElementById(`custom-html-${winId}`).value;
            
            if(!name || !html) return alert("Missing app name or HTML source!");
            
            const key = name.toLowerCase().replace(/\s/g, '');
            const newApp = {
                name, icon, html,
                isCustom: true,
                color: 'text-cyan-400',
                bg: 'bg-cyan-400/20'
            };

            const saved = localStorage.getItem('crunch_custom_apps');
            let customApps = saved ? JSON.parse(saved) : {};
            customApps[key] = newApp;
            localStorage.setItem('crunch_custom_apps', JSON.stringify(customApps));
            
            APPS[key] = newApp;
            renderDesktopIcons();
            renderStartMenu();
            sendNotification('Installer', `${name} installed successfully!`, 'package');
            closeWindow(winId);
        }

        function renderHTML(winId) {
            const input = document.getElementById(`html-url-${winId}`).value;
            const frame = document.getElementById(`html-frame-${winId}`);
            if(input.startsWith('http')) frame.src = input;
            else frame.srcdoc = input;
        }

        function initFilesApp(winId) {
            renderFiles(winId);
        }

        function renderFiles(winId) {
            const grid = document.getElementById(`files-grid-${winId}`);
            grid.innerHTML = '';
            const files = [
                { name: 'System', icon: 'hard-drive', color: 'text-gray-400' },
                { name: 'Downloads', icon: 'download', color: 'text-blue-400' },
                { name: 'Documents', icon: 'file-text', color: 'text-yellow-400' },
                { name: 'Pictures', icon: 'image', color: 'text-pink-400' },
                { name: 'Videos', icon: 'video', color: 'text-purple-400' },
                { name: 'Music', icon: 'music', color: 'text-green-400' }
            ];
            files.forEach(f => {
                const item = document.createElement('div');
                item.className = 'flex flex-col items-center gap-2 group cursor-pointer';
                item.innerHTML = `<div class="w-12 h-12 flex items-center justify-center rounded-xl bg-white/5 group-hover:bg-white/10 transition-colors"><i data-lucide="${f.icon}" class="w-6 h-6 ${f.color}"></i></div><span class="text-[10px] font-bold text-gray-400">${f.name}</span>`;
                grid.appendChild(item);
            });
            lucide.createIcons();
        }

        function showContextMenu(e) {
            e.preventDefault();
            const existing = document.getElementById('context-menu');
            if(existing) existing.remove();
            
            const menu = document.createElement('div');
            menu.id = 'context-menu';
            menu.className = 'fixed bg-[#1a1a1c]/90 backdrop-blur-xl border border-white/10 rounded-xl shadow-2xl py-2 w-48 z-[10002]';
            menu.style.left = e.clientX + 'px';
            menu.style.top = e.clientY + 'px';
            
            const items = [
                { icon: 'refresh-cw', text: 'Refresh Desktop', action: () => location.reload() },
                { icon: 'image', text: 'Change Wallpaper', action: () => launchApp('wallpapers') },
                { icon: 'settings', text: 'System Settings', action: () => launchApp('settings') },
                { icon: 'code', text: 'Terminal Here', action: () => launchApp('terminal') }
            ];
            
            items.forEach(item => {
                const btn = document.createElement('button');
                btn.className = 'w-full flex items-center gap-3 px-4 py-2 text-xs hover:bg-white/10 transition-colors text-left';
                btn.innerHTML = `<i data-lucide="${item.icon}" class="w-3.5 h-3.5 opacity-60"></i> ${item.text}`;
                btn.onclick = () => { item.action(); menu.remove(); };
                menu.appendChild(btn);
            });
            
            document.body.appendChild(menu);
            lucide.createIcons();
            
            const close = () => { menu.remove(); document.removeEventListener('mousedown', close); };
            setTimeout(() => document.addEventListener('mousedown', close), 10);
        }

        // Music App Logic
        let musicState = {
            currentAlbum: null,
            songs: [], 
            isPlaying: false
        };

        function initMusicApp(winId) {
            renderMusicHome(winId);
            const upload = document.getElementById(`audio-upload-${winId}`);
            upload.onchange = (e) => handleMusicUpload(e, winId);
        }

        function renderMusicHome(winId) {
            const grid = document.getElementById(`home-playlists-${winId}`);
            const albums = [
                { name: 'Crunch Mix 2026', artist: 'Crunch OS', color: 'from-cyan-500' },
                { name: 'Lofi Workspace', artist: 'Focus Beats', color: 'from-purple-500' },
                { name: 'Night Drive', artist: 'Synthwave', color: 'from-pink-500' }
            ];
            grid.innerHTML = albums.map(a => `
                <div class="bg-white/5 p-4 rounded-xl hover:bg-white/10 transition-all cursor-pointer group">
                    <div class="aspect-square rounded-lg mb-4 bg-gradient-to-br ${a.color} to-transparent flex items-center justify-center relative">
                        <i data-lucide="music" class="w-12 h-12 text-white/20"></i>
                        <button class="absolute bottom-2 right-2 w-10 h-10 rounded-full bg-green-500 text-black items-center justify-center shadow-xl opacity-0 translate-y-2 group-hover:opacity-100 group-hover:translate-y-0 transition-all flex"><i data-lucide="play" class="fill-current"></i></button>
                    </div>
                    <div class="font-bold text-white truncate">${a.name}</div>
                    <div class="text-xs text-gray-500">${a.artist}</div>
                </div>
            `).join('');
            lucide.createIcons();
        }

        function handleMusicUpload(e, winId) {
            const files = Array.from(e.target.files);
            files.forEach(file => {
                const url = URL.createObjectURL(file);
                musicState.songs.push({ title: file.name.replace('.mp3', ''), artist: 'Local Upload', url });
            });
            sendNotification('Music', `Added ${files.length} songs to library`);
            playSong(musicState.songs[0], winId);
        }

        function playSong(song, winId) {
            const audio = document.getElementById(`music-engine-${winId}`);
            const title = document.getElementById(`now-playing-title-${winId}`);
            const artist = document.getElementById(`now-playing-artist-${winId}`);
            const icon = document.getElementById(`play-btn-icon-${winId}`);
            
            audio.src = song.url;
            audio.play();
            title.textContent = song.title;
            artist.textContent = song.artist;
            musicState.isPlaying = true;
            icon.setAttribute('data-lucide', 'pause');
            lucide.createIcons();

            audio.ontimeupdate = () => {
                const prog = (audio.currentTime / audio.duration) * 100;
                document.getElementById(`audio-progress-${winId}`).style.width = prog + '%';
                document.getElementById(`audio-current-${winId}`).textContent = formatTime(audio.currentTime);
                document.getElementById(`audio-duration-${winId}`).textContent = formatTime(audio.duration);
            };
        }

        function formatTime(s) {
            const min = Math.floor(s / 60);
            const sec = Math.floor(s % 60);
            return `${min}:${sec < 10 ? '0' : ''}${sec}`;
        }

        function toggleAudio(winId) {
            const audio = document.getElementById(`music-engine-${winId}`);
            const icon = document.getElementById(`play-btn-icon-${winId}`);
            if(audio.paused) { audio.play(); icon.setAttribute('data-lucide', 'pause'); }
            else { audio.pause(); icon.setAttribute('data-lucide', 'play'); }
            lucide.createIcons();
        }

        function seekAudio(e, winId) {
            const audio = document.getElementById(`music-engine-${winId}`);
            const rect = e.currentTarget.getBoundingClientRect();
            const pos = (e.clientX - rect.left) / rect.width;
            audio.currentTime = pos * audio.duration;
        }

    </script>
</body>
</html>