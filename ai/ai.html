<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Edu-AI Pro Workspace</title>
    <style>
        :root { --bg: #0d1117; --sidebar: #161b22; --card: #21262d; --accent: #238636; --text: #c9d1d9; --error: #f85149; }
        body, html { margin: 0; padding: 0; height: 100%; background: var(--bg); color: var(--text); font-family: -apple-system, sans-serif; overflow: hidden; }
        .app-container { display: flex; height: 100vh; }
        .sidebar { width: 260px; background: var(--sidebar); display: flex; flex-direction: column; border-right: 1px solid #30363d; }
        .sidebar-header { padding: 20px; font-weight: bold; border-bottom: 1px solid #30363d; display: flex; justify-content: space-between; }
        #history-list { flex: 1; overflow-y: auto; padding: 10px; }
        .main-content { flex: 1; display: flex; flex-direction: column; background: var(--bg); position: relative; }
        #ai-header { display: none; padding: 10px; background: var(--accent); cursor: move; font-weight: bold; justify-content: space-between; }
        #chat-box { flex: 1; overflow-y: auto; padding: 40px 15%; display: flex; flex-direction: column; gap: 20px; }
        .message { max-width: 90%; line-height: 1.6; word-wrap: break-word; }
        .user-msg { align-self: flex-end; background: #238636; color: white; padding: 12px 18px; border-radius: 20px 20px 0 20px; }
        .ai-card { background: var(--card); padding: 20px; border-radius: 12px; border: 1px solid #30363d; }
        .error-card { border-color: var(--error); color: var(--error); }
        b { color: #58a6ff; }
        .math-block { background: #000; padding: 2px 6px; border-radius: 4px; font-family: monospace; color: #ff7b72; }
        .input-area { padding: 20px 15%; background: var(--bg); border-top: 1px solid #30363d; }
        .input-box { background: #161b22; border: 1px solid #30363d; border-radius: 10px; display: flex; padding: 10px; gap: 10px; }
        input[type="text"] { flex: 1; background: transparent; border: none; color: white; outline: none; }
        body.pip-mode .sidebar { display: none; }
        body.pip-mode #ai-header { display: flex; }
        body.pip-mode #chat-box { padding: 15px; }
        body.pip-mode .input-area { padding: 10px; }
        button { cursor: pointer; border: none; border-radius: 6px; padding: 8px 12px; font-weight: bold; }
        .primary-btn { background: var(--accent); color: white; }
    </style>
</head>
<body>

<div class="app-container" id="widget-root">
    <div class="sidebar">
        <div class="sidebar-header"><span>Edu-AI</span><button onclick="newChat()" style="background:#30363d; color:white;">Reset</button></div>
        <div id="history-list">
            <div style="padding:10px; font-size:12px; color:#8b949e;">Memory allows the AI to remember your previous math steps.</div>
        </div>
        <div style="padding:15px;"><button onclick="startPopout()" style="width:100%; background:#21262d; color:#8b949e; border:1px solid #30363d;">Pop Out Window</button></div>
    </div>
    <div class="main-content">
        <div id="ai-header"><span>Edu-AI Floating</span><button onclick="window.close()" style="color:white;">âœ•</button></div>
        <div id="chat-box"></div>
        <div class="input-area">
            <div class="input-box">
                <input type="file" id="file-in" hidden>
                <button onclick="document.getElementById('file-in').click()">ðŸ“·</button>
                <input type="text" id="user-in" placeholder="Type a problem or upload an image...">
                <button class="primary-btn" id="send-btn" onclick="runAI()">Send</button>
            </div>
        </div>
    </div>
</div>

<script>
    const API_KEY = "AIzaSyAGFk-pPaM4uyuXC900FR0QMHzEwQnxqQQ";
    let memory = []; 
    let base64Img = null;

    function formatText(text) {
        let clean = text.replace(/\\mathbf\{(.*?)\}/g, '$1');
        clean = clean.replace(/\\frac\{(.*?)\}\{(.*?)\}/g, '$1/$2');
        clean = clean.replace(/\$(.*?)\$/g, '<span class="math-block">$1</span>');
        clean = clean.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>');
        clean = clean.replace(/### (.*?)\n/g, '<b>$1</b><br>');
        return clean.replace(/\n/g, '<br>');
    }

    async function runAI() {
        const input = document.getElementById('user-in');
        const box = document.getElementById('chat-box');
        const btn = document.getElementById('send-btn');
        const val = input.value.trim();
        if(!val && !base64Img) return;

        const uDiv = document.createElement('div');
        uDiv.className = 'message user-msg';
        uDiv.innerText = val || "Solving image problem...";
        box.appendChild(uDiv);

        memory.push({ role: "user", parts: [{ text: val || "Explain this image." }] });
        if(base64Img) memory[memory.length-1].parts.push({ inlineData: { mimeType: "image/jpeg", data: base64Img } });

        input.value = "Thinking...";
        input.disabled = true;
        btn.disabled = true;

        try {
            const resp = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${API_KEY}`, {
                method: "POST", 
                body: JSON.stringify({ 
                    contents: memory,
                    systemInstruction: { parts: [{ text: "You are a tutor. Use simple fractions (a/b). Show the answer first in bold, then the steps. If there's an image, explain it clearly." }] }
                })
            });

            const data = await resp.json();

            if (resp.status === 429) {
                throw new Error("Rate limit exceeded. Please wait a minute before asking again.");
            }

            if (!data.candidates || !data.candidates[0]) {
                throw new Error(data.error?.message || "AI failed to respond.");
            }

            const aiText = data.candidates[0].content.parts[0].text;
            memory.push({ role: "model", parts: [{ text: aiText }] });

            const aiDiv = document.createElement('div');
            aiDiv.className = 'ai-card message';
            aiDiv.innerHTML = formatText(aiText);
            box.appendChild(aiDiv);
        } catch (e) {
            const errDiv = document.createElement('div');
            errDiv.className = 'ai-card message error-card';
            errDiv.innerHTML = `<b>System Error:</b><br>${e.message}`;
            box.appendChild(errDiv);
            memory.pop(); // Remove failed message from memory
        }

        input.value = ""; input.disabled = false; btn.disabled = false; base64Img = null;
        box.scrollTop = box.scrollHeight;
    }

    async function startPopout() {
        const root = document.getElementById('widget-root');
        const pip = await window.documentPictureInPicture.requestWindow({ width: 400, height: 600 });
        document.body.classList.add('pip-mode');
        [...document.styleSheets].forEach(s => {
            const st = document.createElement('style');
            st.textContent = [...s.cssRules].map(r => r.cssText).join('');
            pip.document.head.appendChild(st);
        });
        pip.document.body.append(root);
        pip.runAI = runAI;
        pip.newChat = newChat;
    }

    function newChat() { 
        document.getElementById('chat-box').innerHTML = '<div class="ai-card">Memory cleared. New session started.</div>'; 
        memory = []; 
    }

    document.getElementById('user-in').onkeydown = (e) => { if(e.key === 'Enter') runAI(); };
    document.getElementById('file-in').onchange = (e) => {
        const reader = new FileReader();
        reader.onload = () => { base64Img = reader.result.split(',')[1]; alert("Image Ready!"); };
        reader.readAsDataURL(e.target.files[0]);
    };
</script>
</body>
</html>